дтнач = ТекущаяДата()

Функция ОбработатьСерв(вых,вх)
    Сообщить("Сервер получил запрос:\n",вх.Сообщение())
    вых.Отправить({"Статус":200, "Тело":"Запрос обработан успешно"})
КонецФункции

серв = Новый Сервер
Попытка
    серв.Открыть("http", "127.0.0.1:9990", 1000, {"/test":ОбработатьСерв}, 0)
Исключение
    Сообщить(ОписаниеОшибки())
    Сообщить("Кажется сервер уже запущен, или тут какая-то другая ошибка, но мы все равно попробуем отправить запрос :)")
КонецПопытки

гр = Новый ГруппаОжидания

фобр = Функция (соед)
		д = соед.Данные()
		Сообщить("Устанавливаем соединение:",соед)
		запр={
            "Метод": "GET",
            "Путь": "http://127.0.0.1:9990/test",
            "Заголовки": {
                "ReqId":соед.Идентификатор(),
                },
            "Параметры": {
                    "id":соед.Идентификатор(),
                    "query":"Запрос по tcp протоколу",
                    "num": д[1],
               },
			}
		Сообщить("Отправляем:", запр)
		Сообщить("Ответ:",соед.Запрос(запр))
        д[0].Завершить() // группа ожидания
	КонецФункции

Для н=1 по 20 Цикл
    кли = Новый Клиент
	гр.Добавить(1)
	кли.Открыть("tcp", "127.0.0.1:9990", фобр, [гр, н])
КонецЦикла

серв.Закрыть()
гр.Ожидать()

Сообщить("Все завершилось просто идеально за", ПрошлоВремениС(дтнач), "!")
